// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

// ==========================================
// PERSONAS Y PARTICIPANTES
// ==========================================

model Persona {
  ID        Int     @id @default(autoincrement())
  Rut       String? @unique @db.VarChar(12)
  Nombre    String  @db.VarChar(100)
  Correo    String  @db.VarChar(100)
  Telefono  String  @db.VarChar(20)
  password  String? @db.VarChar(255)
  sexo      String? @db.NVarChar(50)
  genero    String? @db.NVarChar(50)
  region    String? @db.VarChar(100)
  comuna    String? @db.VarChar(100)
  direccion String? @db.VarChar(200)
  Carrera_Cargo String? @db.VarChar(150) // Carrera (si es estudiante) o Cargo (si es funcionario/académico)

  // Relaciones
  participantes_caso     Participante_Caso[]
  per_par_den            Per_Par_Den[]
  solicitudes_medidas    SolicitudMedida[]
  denuncias              Denuncia[]
  participantes_denuncia Participante_Denuncia[]
  datos_sindicados       Datos_Denunciado[]
  informes_redactados    InformeTecnico[]
  notificaciones         Notificacion[]

  @@map("Persona")
}

model Participante_Caso {
  ID_PC      Int    @id @default(autoincrement())
  ID_Persona Int
  Tipo_PC    String @db.VarChar(50)

  // Relaciones
  persona Persona @relation(fields: [ID_Persona], references: [ID], onDelete: NoAction, onUpdate: NoAction)
  hitos   Hitos[]

  @@map("Participante_Caso")
}

// ==========================================
// DENUNCIAS
// ==========================================

model Denuncia {
  ID_Denuncia         Int       @id @default(autoincrement())
  ID_Denunciante      Int
  ID_TipoDe           Int
  ID_EstadoDe         Int
  Fecha_Ingreso       DateTime  @default(now()) @db.Date // Fecha de ingreso de la denuncia al sistema
  Fecha_Inicio        DateTime  @db.Date // Fecha de inicio de los hechos (o fecha única)
  Fecha_Fin           DateTime? @db.Date // Fecha fin del rango de hechos (opcional, solo si es rango)
  Relato_Hechos       String    @db.Text
  Ubicacion           String?   @db.VarChar(200)
  observacionDirgegen String?   @db.NVarChar(MAX)
  Reserva_Identidad   Boolean  @default(false) // Reserva de identidad del denunciante

  // Relaciones
  denunciante           Persona                 @relation(fields: [ID_Denunciante], references: [ID], onDelete: NoAction, onUpdate: NoAction)
  tipo_denuncia         Tipo_Denuncia           @relation(fields: [ID_TipoDe], references: [ID_TipoDe], onDelete: NoAction, onUpdate: NoAction)
  estado_denuncia       Estado_Denuncia         @relation(fields: [ID_EstadoDe], references: [ID_EstadoDe], onDelete: NoAction, onUpdate: NoAction)
  medidas_cautelares    MedidaCautelar[]
  per_par_den           Per_Par_Den[]
  participante_denuncia Participante_Denuncia[]
  historial_estado      Historial_Estado[]
  solicitudes_medidas   SolicitudMedida[]
  datos_denunciados     Datos_Denunciado[]
  informe_tecnico       InformeTecnico?
  notificaciones        Notificacion[]
  archivos              Archivo[]
  detalle_campo_clinico Detalle_Campo_Clinico?

  @@map("Denuncia")
}

model Tipo_Denuncia {
  ID_TipoDe Int @id

  Nombre      String  @db.VarChar(100)
  Area        String  @db.VarChar(100)
  Descripcion String? @db.VarChar(255)

  // Relaciones
  denuncias Denuncia[]

  @@map("Tipo_Denuncia")
}

model Estado_Denuncia {
  ID_EstadoDe Int    @id @default(autoincrement())
  Tipo_Estado String @db.VarChar(50)

  // Relaciones
  denuncias        Denuncia[]
  historial_estado Historial_Estado[]

  @@map("Estado_Denuncia")
}

// ==========================================
// HISTORIAL DE ESTADOS
// ==========================================

model Historial_Estado {
  ID_Denuncia Int
  ID_EstadoDe Int
  Fecha       DateTime @db.DateTime

  // Relaciones
  denuncia        Denuncia        @relation(fields: [ID_Denuncia], references: [ID_Denuncia], onDelete: Cascade, onUpdate: Cascade)
  estado_denuncia Estado_Denuncia @relation(fields: [ID_EstadoDe], references: [ID_EstadoDe], onDelete: NoAction, onUpdate: NoAction)

  @@id([ID_Denuncia, ID_EstadoDe])
  @@map("Historial_Estado")
}

// ==========================================
// PARTICIPANTES EN DENUNCIAS
// ==========================================

model Participante_Denuncia {
  ID_PD       Int    @id @default(autoincrement())
  ID_Denuncia Int
  ID_Persona  Int?
  Nombre_PD   String @db.VarChar(100)

  // Relaciones
  denuncia Denuncia @relation(fields: [ID_Denuncia], references: [ID_Denuncia], onDelete: Cascade, onUpdate: Cascade)
  persona  Persona? @relation(fields: [ID_Persona], references: [ID], onDelete: NoAction, onUpdate: NoAction)

  @@map("Participante_Denuncia")
}

// ==========================================
// RELACIÓN PERSONA-PARTICIPANTE-DENUNCIA
// ==========================================

model Per_Par_Den {
  ID_PD        Int    @id @default(autoincrement())
  ID_Denuncia  Int
  ID_Persona   Int
  Cargo_actual String @db.VarChar(100)

  // Relaciones
  persona  Persona  @relation(fields: [ID_Persona], references: [ID], onDelete: NoAction, onUpdate: NoAction)
  denuncia Denuncia @relation(fields: [ID_Denuncia], references: [ID_Denuncia], onDelete: Cascade, onUpdate: Cascade)

  @@map("Per_Par_Den")
}

// ==========================================
// MEDIDAS CAUTELARES
// ==========================================

model MedidaCautelar {
  ID_MC        Int      @id @default(autoincrement())
  ID_Denuncia  Int
  Fecha_Inicio DateTime @db.Date
  Fecha_Fin    DateTime @db.Date
  Detalle      String   @db.Text

  // Relaciones
  denuncia       Denuncia        @relation(fields: [ID_Denuncia], references: [ID_Denuncia], onDelete: Cascade, onUpdate: Cascade)
  tipos_cautelar Tipo_Cautelar[]

  @@map("MedidaCautelar")
}

model Tipo_Cautelar {
  ID_MC  Int    @id
  Nombre String @db.VarChar(100)

  // Relaciones
  medida_cautelar MedidaCautelar @relation(fields: [ID_MC], references: [ID_MC], onDelete: Cascade, onUpdate: Cascade)

  @@map("Tipo_Cautelar")
}

// ==========================================
// SOLICITUDES DE MEDIDAS DE RESGUARDO (NUEVO)
// ==========================================

model SolicitudMedida {
  ID_Solicitud    Int      @id @default(autoincrement())
  ID_Denuncia     Int
  ID_Solicitante  Int
  Fecha_Solicitud DateTime @default(now())

  Tipo_Medida String @db.VarChar(100)

  Estado String @db.VarChar(50)

  // Archivos obligatorios según el flujo
  Informe_Tecnico    String? @db.VarChar(255)
  Archivo_Resolucion String? @db.VarChar(255)

  Observacion String? @db.Text

  // Relaciones
  denuncia Denuncia @relation(fields: [ID_Denuncia], references: [ID_Denuncia], onDelete: Cascade, onUpdate: Cascade)
  persona  Persona  @relation(fields: [ID_Solicitante], references: [ID], onDelete: NoAction, onUpdate: NoAction)

  @@map("SolicitudMedida")
}

// ==========================================
// INFORME TÉCNICO (DIRGEGEN)
// ==========================================

model InformeTecnico {
  ID_Informe Int @id @default(autoincrement())

  // Claves foráneas
  ID_Denuncia Int @unique
  ID_Autor    Int

  Fecha_Emision DateTime @default(now())

  // Contenido
  Antecedentes      String  @db.Text
  Analisis_Social   String  @db.Text
  Analisis_Psico    String  @db.Text
  Analisis_Juridico String  @db.Text
  Sugerencias       String  @db.Text
  Es_Confidencial   Boolean @default(true)

  // Relaciones (Puentes cerrados correctamente)
  denuncia Denuncia @relation(fields: [ID_Denuncia], references: [ID_Denuncia], onDelete: Cascade)
  autor    Persona  @relation(fields: [ID_Autor], references: [ID], onDelete: NoAction)

  @@map("InformeTecnico")
}

// ==========================================
// HITOS Y ARCHIVOS
// ==========================================

model Hitos {
  ID_Hitos    Int     @id @default(autoincrement())
  ID_PC       Int
  Nombre      String  @db.VarChar(100)
  Descripcion String? @db.Text

  // Relaciones
  participante_caso Participante_Caso @relation(fields: [ID_PC], references: [ID_PC], onDelete: Cascade, onUpdate: Cascade)
  tipo_hitos        Tipo_Hito[]
  archivos          Archivo[]

  @@map("Hitos")
}

model Tipo_Hito {
  ID_Tipo_Hito Int    @id @default(autoincrement())
  ID_Hitos     Int
  Nombre       String @db.VarChar(100)

  // Relaciones
  hito Hitos @relation(fields: [ID_Hitos], references: [ID_Hitos], onDelete: Cascade, onUpdate: Cascade)

  @@map("Tipo_Hito")
}

model Archivo {
  ID_Archivo      Int     @id @default(autoincrement())
  ID_Hitos        Int
  ID_Denuncia     Int // Relación directa con Denuncia para evitar mezclar archivos entre denuncias
  Archivo         String  @db.VarChar(255) // Mantener para compatibilidad (deprecated)
  MinIO_Key       String? @db.VarChar(500) // Clave del objeto en MinIO (UUID-nombre)
  Nombre_Original String? @db.VarChar(255) // Nombre original del archivo
  Tipo_Archivo    String? @db.VarChar(100) // MIME type (ej: image/jpeg, application/pdf)
  Tamaño         BigInt? // Tamaño en bytes

  // Relaciones
  hito     Hitos    @relation(fields: [ID_Hitos], references: [ID_Hitos], onDelete: Cascade, onUpdate: Cascade)
  denuncia Denuncia @relation(fields: [ID_Denuncia], references: [ID_Denuncia], onDelete: Cascade, onUpdate: Cascade)

  @@map("Archivo")
}

// ==========================================
// DATOS DENUNCIADO (SINDICADOS)
// ==========================================

model Datos_Denunciado {
  ID_Datos         Int     @id @default(autoincrement())
  ID_Denuncia      Int
  Nombre_Ingresado String? @db.VarChar(100)
  Descripcion      String? @db.Text
  Ubicacion_Hechos String? @db.VarChar(200)
  ID_Persona       Int? // FK a Persona (solo si se identifica)

  // Relaciones
  denuncia Denuncia @relation(fields: [ID_Denuncia], references: [ID_Denuncia], onDelete: Cascade, onUpdate: Cascade)
  persona  Persona? @relation(fields: [ID_Persona], references: [ID], onDelete: NoAction, onUpdate: NoAction)

  @@map("Datos_Denunciado")
}

// ==========================================
// DETALLE CAMPO CLÍNICO (NCG N°4)
// ==========================================

model Detalle_Campo_Clinico {
  ID_Denuncia                Int    @id // Relación 1:1 con Denuncia
  Nombre_Establecimiento     String @db.VarChar(200) // Nombre del hospital/centro de salud
  Unidad_Servicio            String @db.VarChar(200) // Ej. "Urgencias", "Pediatría"
  Tipo_Vinculacion_Denunciado String @db.VarChar(100) // Valores: 'Docente IES', 'Personal Colaboración Docente (Tutor Hospital)', 'Estudiante', 'Administrativo'
  Region                     String? @db.VarChar(100) // Región del establecimiento
  Comuna                     String? @db.VarChar(100) // Comuna del establecimiento
  Direccion_Establecimiento  String? @db.VarChar(200) // Dirección del establecimiento

  // Relaciones
  denuncia Denuncia @relation(fields: [ID_Denuncia], references: [ID_Denuncia], onDelete: Cascade, onUpdate: Cascade)

  @@map("Detalle_Campo_Clinico")
}

// ==========================================
// NOTIFICACIONES
// ==========================================

model Notificacion {
  ID_Notificacion Int      @id @default(autoincrement())
  ID_Usuario      Int // Usuario destinatario
  Tipo            String   @db.VarChar(50) // 'NUEVA_DENUNCIA', 'RECORDATORIO', etc.
  Titulo          String   @db.VarChar(200)
  Mensaje         String   @db.Text
  Leida           Boolean  @default(false)
  Fecha_Creacion  DateTime @default(now())
  ID_Denuncia     Int? // FK opcional a Denuncia relacionada
  Enviado_Email   Boolean  @default(false) // Si se envió correo electrónico

  // Relaciones
  usuario  Persona   @relation(fields: [ID_Usuario], references: [ID], onDelete: Cascade, onUpdate: Cascade)
  denuncia Denuncia? @relation(fields: [ID_Denuncia], references: [ID_Denuncia], onDelete: SetNull, onUpdate: Cascade)

  @@map("Notificacion")
}
